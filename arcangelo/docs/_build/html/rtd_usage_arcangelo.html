<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Digest of arcangelo &#8212; wok_code 2.0.22 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/nature.css?v=279e0f84" />
    <script src="_static/jquery.js?v=5d32c60e"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="_static/documentation_options.js?v=7318b3e0"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Digest of gen_readme" href="rtd_description_gen_readme.html" />
    <link rel="prev" title="Digest of arcangelo" href="rtd_description_arcangelo.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="rtd_description_gen_readme.html" title="Digest of gen_readme"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="rtd_description_arcangelo.html" title="Digest of arcangelo"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">wok_code 2.0.22 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Digest of arcangelo</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="toctree-wrapper compound">
</div>
<section id="digest-of-arcangelo">
<h1>Digest of arcangelo<a class="headerlink" href="#digest-of-arcangelo" title="Link to this heading"></a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>usage: arcangelo.py [-h] [-a] [-B] [-b TO_VERSION] [-C RULE_GROUPS] [-c]
                    [-F FROM_VERSION] [-f] [-G GIT_ORGID]
                    [--git-merge-conflict left|right] [--ignore-pragma] [-i]
                    [-j PYTHON] [-l] [-n] [-o OUTPUT] [-P PACKAGE_NAME]
                    [-R RULES] [-S] [--test-res-msg TEST_RES_MSG] [-v] [-V]
                    [-w] [--add-rule-group ADD_RULE_GROUP]
                    [path ...]

Beautiful source file

positional arguments:
  path

options:
  -h, --help            show this help message and exit
  -a, --lint-anyway     set to True when migrate software
  -B, --debug           add comment with applied rule: do not use in
                        production
  -b TO_VERSION, --to-version TO_VERSION
  -C RULE_GROUPS, --rule-groups RULE_GROUPS
                        Rule groups (comma separated) to parse (use + for
                        adding, - for removing) use switch -l to see default
                        groups list
  -c, --copyright-check
  -F FROM_VERSION, --from-version FROM_VERSION
  -f, --force           Parse file even containing &#39;# flake8: noqa&#39; or &#39;#
                        pylint: skip-file&#39;
  -G GIT_ORGID, --git-org GIT_ORGID
  --git-merge-conflict left|right
                        Keep left or right side code after git merge conflict
  --ignore-pragma       ignore coding utf-8 declaration
  -i, --in-place
  -j PYTHON, --python PYTHON
                        python version, format #.##, 2-3 use future
  -l, --list-rules      list rule groups (-ll list with rules too, -lll full
                        list)
  -n, --dry-run         do nothing (dry-run)
  -o OUTPUT, --output OUTPUT
  -P PACKAGE_NAME, --package-name PACKAGE_NAME
  -R RULES, --rules RULES
                        Rules (comma separated) to parse (use - for removing)
                        use switch -ll to see default rules list
  -S, --string-normalization
                        force double quote enclosing strings
  --test-res-msg TEST_RES_MSG
  -v, --verbose
  -V, --version         show program&#39;s version number and exit
  -w, --no-parse-with-formatter
                        do nor execute black or prettier on modified files
  --add-rule-group ADD_RULE_GROUP
                        Add rule group form file, default is .arcangelo.yml

© 2021-2025 by SHS-AV s.r.l.
</pre></div>
</div>
<p><strong>arcangelo</strong> is based on rules files located in config directory where arcangelo
is running. Configuration files are yaml formatted.</p>
<p>Every rule is list of following format:</p>
<blockquote>
<div><p>PYEREX, (ACTION, PARAMETERS), …</p>
<p>where</p>
<ul class="simple">
<li><p>PYEREX is (python expression + enhanced regular expression) for applying the rule</p></li>
<li><p>ACTION is the action to apply on current item (if PYEREX is matched)</p></li>
<li><p>PARAMETERS are the values supplying to action</p></li>
</ul>
</div></blockquote>
<p>The list/tuple (ACTION, PARAMETERS) can be repeated more than once under PYEREX</p>
<p><strong>PYEREX is (python expression + enhanced regular expression)</strong> is a set of 3
distinct expressions, which are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Python expression (in order to apply eregex): enclosed by double braces</p></li>
<li><p>Status eregex match (in order to apply eregex): enclosed by parens</p></li>
<li><p>Applicable eregex to match item</p></li>
</ol>
<p>ACTION is applied if (python expression AND status eregex AND applicable eregex);
the undeclared python expression or undeclared status eregx returns always true.</p>
<p>eregex is a regular expression (python re) that may be negative if it starts with !
(exclamation mark)</p>
<p>Examples:</p>
</div></blockquote>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Pos</p></td>
<td><p>Example</p></td>
<td><p>Note</p></td>
<td><p>Action</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>REGEX</p></td>
<td><p>REGEX is a python re</p></td>
<td><p>item is processed if it matches REGEX</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>!REGEX</p></td>
<td><p>REGEX is a python re</p></td>
<td><p>item is processes if it does not match REGEX</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>\!REGEX</p></td>
<td><p>REGEX is a python re beginning with ! (exclamation point)</p></td>
<td><p>like case 1</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>!(RE)REGEX</p></td>
<td><p>RE and REGEX are two python re</p></td>
<td><p>if item does not match (by search) the RE, apply rule 1</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>{{EXPR}}EREGEX</p></td>
<td><p>EXPR is double expression</p></td>
<td><p>EREGEX is processed if pythonic EXPR is true</p></td>
</tr>
</tbody>
</table>
<blockquote>
<div><ul class="simple">
<li><p>!(import xyz)import -&gt; Rules is applied if matches the statemente “import” but not “import zyz”</p></li>
<li><p>{{self.to_major_version&gt;10}}import something -&gt; If target Odoo version is &gt;10.0 matches statement “import something”, otherwise ignore rule</p></li>
<li><p>{{self.from_major_version&lt;=10}}import something -&gt; If original Odoo version is &lt;=10.0 matches statement “import something”, otherwise ignore rule</p></li>
<li><p>{{self.python_version==3.10}}open -&gt; If python version is 3.10, matches statemente import, otherwise ignore rule</p></li>
<li><p>{{self.py23==3}}open -&gt; If python major version is 3, matches statemente import, otherwise ignore rule</p></li>
</ul>
</div></blockquote>
<p><strong>ACTION is the action will be executed</strong> when EREGEX is True or when EREGEX fails if action begins with “/” (slash).</p>
<blockquote>
<div><p><strong>ACTION values</strong>:</p>
<ul class="simple">
<li><p><strong>s</strong>: substitute REGEX REPLACE_TEXT</p></li>
<li><p><strong>d</strong>: delete line; stop immediately rule processing and re-read the line</p></li>
<li><p><strong>i</strong>: insert line before current line</p></li>
<li><p><strong>a</strong>: append line after current line</p></li>
<li><p><strong>$</strong>: execute FUNCTION</p></li>
<li><p><strong>+</strong>: set trigger TRIGGER_NAME (from 1st group of matching regex)</p></li>
<li><p><strong>-</strong>: reset trigger TRIGGER_NAME</p></li>
<li><p><strong>=</strong>: execute python code</p></li>
</ul>
</div></blockquote>
<p><strong>Python test and replacing macros</strong>.</p>
<p>Above you can find some simple example of python expression. The following table
contains the list of values can used in python expression or in text replacement for
substitute action. For example, the value classname can be used in following python
expression:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>\<span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">classname</span><span class="o">==</span><span class="s2">&quot;MyClass&quot;</span><span class="p">}}</span>
</pre></div>
</div>
<p>while in replacement text the form is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;s&#39;</span> <span class="nb">super</span><span class="p">()</span> <span class="nb">super</span><span class="p">(</span><span class="o">%</span><span class="p">(</span><span class="n">classname</span><span class="p">)</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<p>Value list:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>Description</p></td>
</tr>
<tr class="row-even"><td><p>backport_multi</p></td>
<td><p>Processing a backported version (multiple version path)</p></td>
</tr>
<tr class="row-odd"><td><p>classname</p></td>
<td><p>Name of current class</p></td>
</tr>
<tr class="row-even"><td><p>dedent</p></td>
<td><p>Dedent statement level</p></td>
</tr>
<tr class="row-odd"><td><p>final</p></td>
<td><p>Processing final version when multiple version path</p></td>
</tr>
<tr class="row-even"><td><p>first_line</p></td>
<td><p>True if current line is the 1st of source (see header too)</p></td>
</tr>
<tr class="row-odd"><td><p>from_major_version</p></td>
<td><p>Major version of project by -F switch</p></td>
</tr>
<tr class="row-even"><td><p>header</p></td>
<td><p>Current line is in the file header (comments and empty lines)</p></td>
</tr>
<tr class="row-odd"><td><p>imported</p></td>
<td><p>Imported packages list</p></td>
</tr>
<tr class="row-even"><td><p>indent</p></td>
<td><p>Space indentation of current line</p></td>
</tr>
<tr class="row-odd"><td><p>migration_multi</p></td>
<td><p>Processing a migrate version with multiple version path</p></td>
</tr>
<tr class="row-even"><td><p>mime</p></td>
<td><p>Current file mime</p></td>
</tr>
<tr class="row-odd"><td><p>open_stmt</p></td>
<td><p># of open parens; if &gt; 0, current line is a continuation line</p></td>
</tr>
<tr class="row-even"><td><p>python_future</p></td>
<td><p>True if source is python 2 and 3 with future</p></td>
</tr>
<tr class="row-odd"><td><p>stage</p></td>
<td><p>Parsing stage: pre,header,import,class_body,function_body,comment</p></td>
</tr>
<tr class="row-even"><td><p>stmt_indent</p></td>
<td><p>Space indentation of current statement</p></td>
</tr>
<tr class="row-odd"><td><p>to_major_version</p></td>
<td><p>Major version of project by -b switch</p></td>
</tr>
<tr class="row-even"><td><p>transition_stage</p></td>
<td><p>Prior parsing stage</p></td>
</tr>
<tr class="row-odd"><td><p>try_indent</p></td>
<td><p>try statement indentation: if &gt;=0 current line is inside try/except block</p></td>
</tr>
<tr class="row-even"><td><p>py23</p></td>
<td><p>Value 2 if python2 else 3 (int)</p></td>
</tr>
</tbody>
</table>
<p>Action <strong>substitute</strong>: “s REGEX REPLACE_TEXT”</p>
<blockquote>
<div><ul class="simple">
<li><p>The 1.st item is the EREGEX to search for replace (negate is not applied)</p></li>
<li><p>The 2.nd item is the text to replace which can contain macros like %(classname)s</p></li>
</ul>
</div></blockquote>
<p>Action <strong>delete</strong>: “d”</p>
<blockquote>
<div><ul class="simple">
<li><p>Delete current line</p></li>
<li><p>Break rules analyzing</p></li>
</ul>
</div></blockquote>
<p>Action <strong>insert</strong>: “i text”</p>
<blockquote>
<div><ul class="simple">
<li><p>Insert text before current line</p></li>
</ul>
</div></blockquote>
<p>Action <strong>append</strong>: “a text”</p>
<blockquote>
<div><ul class="simple">
<li><p>Append text after current line</p></li>
</ul>
</div></blockquote>
<p>Action <strong>execute</strong>: “$ FUNCTION”</p>
<blockquote>
<div><ul class="simple">
<li><p>Function must return requires break and line offset</p></li>
<li><p>If function requires break, no other rules will be processed</p></li>
<li><p>The value 0 for offset means read next line, the value -1 re-read the current line, +1 skip next line, and so on</p></li>
</ul>
<p>Function example:</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">FUNCTION</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nro</span><span class="p">):</span>
    <span class="n">do_break</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">nro</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;odoo&gt;&quot;</span><span class="p">:</span>
        <span class="n">do_break</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">do_break</span><span class="p">,</span> <span class="n">offset</span>
</pre></div>
</div>
<p>Rules examples:</p>
<p>Follow rule replace “&#64;api.one” with “# &#64;api.one” and adds comment line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">no_api_mix</span><span class="p">:</span>
  <span class="n">match</span><span class="p">:</span> <span class="s1">&#39;^ *@api\.(one|returns|cr|model_cr|model_cr_context|v8|noguess)&#39;</span>
  <span class="n">do</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">action</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span>
      <span class="n">args</span><span class="p">:</span>
      <span class="o">-</span> <span class="s1">&#39;@api\.(one|returns|cr|model_cr|model_cr_context|v8|noguess)&#39;</span>
      <span class="o">-</span> <span class="s1">&#39;# @api.</span><span class="se">\1</span><span class="s1">&#39;</span>
    <span class="o">-</span> <span class="n">action</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span>
      <span class="n">args</span><span class="p">:</span>
      <span class="o">-</span> <span class="s1">&#39;# TODO&gt; Update code to multi or add self.ensure_one()&#39;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/logozero_180x46.png" alt="Logo of wok_code"/>
            </a></p>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="rtd_description_arcangelo.html"
                          title="previous chapter">Digest of arcangelo</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="rtd_description_gen_readme.html"
                          title="next chapter">Digest of gen_readme</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/rtd_usage_arcangelo.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="rtd_description_gen_readme.html" title="Digest of gen_readme"
             >next</a> |</li>
        <li class="right" >
          <a href="rtd_description_arcangelo.html" title="Digest of arcangelo"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">wok_code 2.0.22 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Digest of arcangelo</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2019-24, SHS-AV s.r.l..
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>